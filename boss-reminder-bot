import discord
from discord.ext import commands, tasks
import datetime
import json
import os

TOKEN = os.getenv("BOT_TOKEN")  # å¾ Railway ç’°å¢ƒè®Šæ•¸è®€å– Token

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

boss_data = {
    "å°å·´": 6 * 60 + 45,
    "é›ªå¥³": 2 * 60 + 40,
    "é›ªæ¯›æ€ªäºº": 45,
    "é»‘è¼ªç‹": 13 * 60,
    "ä¹å°¾": 3 * 60 + 30,
    "æ›¸ç”Ÿ": 2 * 60 + 30,
    "æ®­å±å§‘å§‘ç‹": 3 * 60 + 15
}

DATA_FILE = "death_records.json"

# è¼‰å…¥ç´€éŒ„æª”
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r") as f:
        death_times = json.load(f)
else:
    death_times = {}

@bot.event
async def on_ready():
    print(f"âœ… æ©Ÿå™¨äººå·²å•Ÿå‹•ç‚ºï¼š{bot.user}")
    reminder_loop.start()

@bot.command()
async def kill(ctx, boss: str, channel: discord.TextChannel = None):
    if boss not in boss_data:
        await ctx.send(f"âŒ æ²’æœ‰é€™éš»ç‹ï¼š{boss}")
        return

    now = datetime.datetime.utcnow().isoformat()
    record = {
        "time": now,
        "channel_id": (channel.id if channel else ctx.channel.id)
    }
    death_times[boss] = record

    with open(DATA_FILE, "w") as f:
        json.dump(death_times, f)

    await ctx.send(
        f"âœ… å·²è¨˜éŒ„ {boss} çš„æ­»äº¡æ™‚é–“ç‚º {datetime.datetime.utcnow().strftime('%H:%M UTC')}ï¼Œå°‡æ–¼ <#{record['channel_id']}> ç™¼é€æé†’"
    )

@bot.command()
async def respawn(ctx, boss: str):
    if boss not in death_times:
        await ctx.send(f"âš ï¸ å°šæœªè¨˜éŒ„ {boss} çš„æ­»äº¡æ™‚é–“")
        return

    dt = datetime.datetime.fromisoformat(death_times[boss]["time"])
    respawn_dt = dt + datetime.timedelta(minutes=boss_data[boss])
    await ctx.send(f"ğŸ•’ {boss} é è¨ˆé‡ç”Ÿæ™‚é–“ï¼š{respawn_dt.strftime('%Y-%m-%d %H:%M UTC')}")

@bot.command()
async def bosslist(ctx):
    if not death_times:
        await ctx.send("ğŸ“­ å°šæœªè¨˜éŒ„ä»»ä½•ç‹")
        return

    msg = "ğŸ“œ ç‹é‡ç”Ÿæ¸…å–®ï¼š\n"
    for boss, info in death_times.items():
        dt = datetime.datetime.fromisoformat(info["time"])
        respawn_dt = dt + datetime.timedelta(minutes=boss_data[boss])
        msg += f"ğŸ”¸ {boss} â†’ {respawn_dt.strftime('%H:%M UTC')} | é »é“ï¼š<#{info['channel_id']}>\n"
    await ctx.send(msg)

@tasks.loop(minutes=1)
async def reminder_loop():
    now = datetime.datetime.utcnow()
    for boss, info in list(death_times.items()):
        dt = datetime.datetime.fromisoformat(info["time"])
        respawn_dt = dt + datetime.timedelta(minutes=boss_data[boss])
        delta = (respawn_dt - now).total_seconds()

        try:
            channel = bot.get_channel(info["channel_id"])
            if not channel:
                continue
            if 0 < delta <= 600:
                await channel.send(f"â° {boss} å°‡åœ¨ 10 åˆ†é˜å…§é‡ç”Ÿï¼")
            elif -60 < delta <= 0:
                await channel.send(f"ğŸ‰ {boss} å·²é‡ç”Ÿå›‰ï¼Œå¿«é›†åˆï¼")
        except Exception as e:
            print(f"æé†’å¤±æ•—ï¼š{boss} â†’ {e}")

bot.run(TOKEN)
